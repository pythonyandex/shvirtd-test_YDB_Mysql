from datetime import datetime
import os
import time
from contextlib import contextmanager, asynccontextmanager

import mysql.connector
from mysql.connector import Error
from fastapi import FastAPI, Request, Depends, Header
from typing import Optional


# --- 1. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
# –°—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ë–î –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
db_host = os.environ.get('DB_HOST', 'db')
db_user = os.environ.get('DB_USER', 'app')
db_password = os.environ.get('DB_PASSWORD', 'QwErTy1234')
db_name = os.environ.get('DB_NAME', 'example')

@asynccontextmanager
async def lifespan(app: FastAPI):
    # –ö–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    print("=" * 50)
    print("–ü–†–ò–õ–û–ñ–ï–ù–ò–ï –ó–ê–ü–£–°–ö–ê–ï–¢–°–Ø...")
    print(f"–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ë–î: host={db_host}, user={db_user}, db={db_name}")
    print("=" * 50)

    # –ú–ù–û–ì–û–ö–†–ê–¢–ù–´–ï –ü–û–ü–´–¢–ö–ò –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    max_retries = 15  # –£–≤–µ–ª–∏—á–∏–ª–∏ –¥–æ 15 –ø–æ–ø—ã—Ç–æ–∫
    connected = False

    for attempt in range(max_retries):
        try:
            print(f"\n[–ü–æ–ø—ã—Ç–∫–∞ {attempt + 1}/{max_retries}] –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î...")
            with get_db_connection() as db:
                cursor = db.cursor()
                print("‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ!")

                # –ü—Ä–æ–≤–µ—Ä—è–µ–º/—Å–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
                create_table_query = """
                CREATE TABLE IF NOT EXISTS requests (
                    id INT AUTO_INCREMENT PRIMARY KEY,
                    request_date DATETIME,
                    request_ip VARCHAR(255)
                )
                """
                cursor.execute(create_table_query)
                db.commit()

                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                cursor.execute("SHOW TABLES LIKE 'requests'")
                result = cursor.fetchone()
                if result:
                    print("‚úÖ –¢–∞–±–ª–∏—Ü–∞ 'requests' —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∞")
                else:
                    print("‚ö†Ô∏è  –¢–∞–±–ª–∏—Ü–∞ 'requests' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è")

                cursor.close()
                connected = True
                print("üéâ –ë–î –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ!")
                break  # –£—Å–ø–µ—à–Ω–æ, –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ü–∏–∫–ª–∞

        except Error as err:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {err}")
            if attempt < max_retries - 1:
                wait_time = 3
                print(f"‚è≥ –ñ–¥—É {wait_time} —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π...")
                time.sleep(wait_time)
            else:
                print("üí• –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ë–î –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫")

    if not connected:
        print("üö® –í–ù–ò–ú–ê–ù–ò–ï: –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ë–ï–ó –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î!")

    print("=" * 50)
    yield
    print("–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è.")


# –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä FastAPI —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º lifespan
app = FastAPI(
    title="Shvirtd Example FastAPI",
    description="–£—á–µ–±–Ω—ã–π –ø—Ä–æ–µ–∫—Ç, FastAPI+Docker.",
    version="1.0.0",
    lifespan=lifespan
)


# --- 2. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º —Å –ë–î ---
@contextmanager
def get_db_connection():
    db = None
    try:
        db = mysql.connector.connect(
            host=os.getenv("DB_HOST"),
            user=os.getenv("DB_USER"),
            password=os.getenv("DB_PASSWORD"),
            database=os.getenv("DB_NAME"),
            ssl_ca='/etc/ssl/certs/yandex-ca.pem',  # –ü—É—Ç—å –∫ CA-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—É
            ssl_verify_cert=True
        )
        yield db
    finally:
        if db is not None and db.is_connected():
            db.close()


# --- 3. –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è IP ---
def get_client_ip(x_real_ip: Optional[str] = Header(None)):
    return x_real_ip


# --- 4. –û—Å–Ω–æ–≤–Ω–æ–π —ç–Ω–¥–ø–æ–∏–Ω—Ç ---
@app.get("/")
def index(request: Request, ip_address: Optional[str] = Depends(get_client_ip)):
    final_ip = ip_address  # –¢–æ–ª—å–∫–æ –∏–∑ X-Forwarded-For, –±–µ–∑ fallback

    now = datetime.now()
    current_time = now.strftime("%Y-%m-%d %H:%M:%S")

    try:
        with get_db_connection() as db:
            cursor = db.cursor()
            query = "INSERT INTO requests (request_date, request_ip) VALUES (%s, %s)"
            values = (current_time, final_ip)
            cursor.execute(query, values)
            db.commit()
            cursor.close()
    except mysql.connector.Error as err:
        return {"error": f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö: {err}"}

    # –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –ø—Ä–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏
    if final_ip is None:
        ip_display = "–ø–æ—Ö–æ–∂–µ, —á—Ç–æ –≤—ã –Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç–µ –∑–∞–ø—Ä–æ—Å –≤ –Ω–µ–≤–µ—Ä–Ω—ã–π –ø–æ—Ä—Ç(–Ω–∞–ø—Ä–∏–º–µ—Ä curl http://127.0.0.1:5000). –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è - –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –≤ –ø–æ—Ä—Ç 8090."
    else:
        ip_display = final_ip

    return f'TIME: {current_time}, IP: {ip_display}'


# --- 5. –û—Ç–ª–∞–¥–æ—á–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç ---
@app.get("/debug")
def debug_headers(request: Request):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –æ—Ç–∫—É–¥–∞ –±–µ—Ä–µ—Ç—Å—è IP"""
    return {
        "headers": dict(request.headers),
        "client_host": request.client.host if request.client else None,
        "x_forwarded_for": request.headers.get('x-forwarded-for'),
        "real_ip": request.headers.get('x-real-ip'),
        "forwarded": request.headers.get('forwarded')
    }


# --- 6. –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞–ø–∏—Å–µ–π –≤ –ë–î ---
@app.get("/requests")
def get_requests():
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ –∑–∞–ø–∏—Å–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã requests –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏"""
    try:
        with get_db_connection() as db:
            cursor = db.cursor()
            query = "SELECT id, request_date, request_ip FROM requests ORDER BY id DESC LIMIT 50"
            cursor.execute(query)
            records = cursor.fetchall()
            cursor.close()

            # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∑–∞–ø–∏—Å–∏ –≤ —á–∏—Ç–∞–±–µ–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
            result = []
            for record in records:
                result.append({
                    "id": record[0],
                    "request_date": record[1].strftime("%Y-%m-%d %H:%M:%S") if record[1] else None,
                    "request_ip": record[2]
                })

            return {
                "total_records": len(result),
                "records": result
            }
    except mysql.connector.Error as err:
        return {"error": f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {err}"}


# --- 7. –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---
# –î–ª—è –∑–∞–ø—É—Å–∫–∞ —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ASGI-—Å–µ—Ä–≤–µ—Ä, –Ω–∞–ø—Ä–∏–º–µ—Ä, uvicorn.
# –ö–æ–º–∞–Ω–¥–∞: uvicorn main:app --reload
if __name__ == '__main__':
    import uvicorn
    uvicorn.run(app, host='0.0.0.0', port=5000)
